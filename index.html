<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Knife Hit - Fixed Version</title>
    <style>
        body {
            margin: 0; padding: 0; background-color: #1a1a1a;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; font-family: 'Arial', sans-serif;
            touch-action: none;
        }
        #game-container { position: relative; }
        canvas { background: radial-gradient(circle, #34495e, #2c3e50); display: block; cursor: pointer; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; padding: 20px; box-sizing: border-box; color: white;
        }
        .level-info { font-size: 28px; font-weight: bold; }
        .knives-left { display: flex; flex-direction: column-reverse; gap: 8px; }
        .knife-icon { font-size: 24px; filter: grayscale(1); opacity: 0.3; transition: 0.3s; }
        .knife-icon.active { filter: grayscale(0); opacity: 1; }
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; flex-direction: column;
            justify-content: center; align-items: center; color: white; z-index: 10;
        }
        button {
            margin-top: 20px; padding: 15px 40px; background: #f1c40f;
            border: none; color: #2c3e50; font-size: 20px; font-weight: bold;
            cursor: pointer; border-radius: 50px; pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div class="level-info">LVL: <span id="levelNum">1</span></div>
        <div class="knives-left" id="knivesCounter"></div>
    </div>
    <div id="game-over">
        <h1 id="resTitle">GAME OVER</h1>
        <p>Score: <span id="finalScore">0</span></p>
        <button onclick="initGame()">RESTART</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 480;
    canvas.height = 640;

    let gameState = {
        isRunning: false,
        level: 1,
        score: 0,
        knivesToThrow: 6,
        knivesRemaining: 6
    };

    const target = {
        x: canvas.width / 2,
        y: 200,
        radius: 85,
        angle: 0,
        rotationSpeed: 0.03,
        stuckKnives: [],
        shakeY: 0 // –î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —É–¥–∞—Ä–∞
    };

    const knife = {
        x: canvas.width / 2,
        y: canvas.height - 120,
        w: 12,
        h: 70,
        speed: 30,
        isFlying: false,
        isReady: true
    };

    function initGame() {
        gameState.level = 1;
        gameState.score = 0;
        setupLevel(1);
        gameState.isRunning = true;
        document.getElementById('game-over').style.display = 'none';
        gameLoop();
    }

    function setupLevel(lvl) {
        gameState.knivesToThrow = 5 + lvl;
        gameState.knivesRemaining = gameState.knivesToThrow;
        target.stuckKnives = [];
        // –ú–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        let speed = 0.02 + (lvl * 0.008);
        target.rotationSpeed = (lvl % 2 === 0) ? -speed : speed;
        updateUI();
    }

    function update() {
        if (!gameState.isRunning) return;

        target.angle += target.rotationSpeed;
        
        // –ü–ª–∞–≤–Ω–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –±—Ä–µ–≤–Ω–∞ –ø–æ—Å–ª–µ —Ç—Ä—è—Å–∫–∏
        if (target.shakeY < 0) target.shakeY += 1;

        if (knife.isFlying) {
            knife.y -= knife.speed;

            // –ö–æ–ª–ª–∏–∑–∏—è —Å –±—Ä–µ–≤–Ω–æ–º
            if (knife.y <= target.y + target.radius) {
                checkHit();
            }
        }
    }

    function checkHit() {
        knife.isFlying = false;
// –í–ê–ñ–ù–û: –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –≤—Ö–æ–¥–∞. 
        // –ù–æ–∂ –ª–µ—Ç–∏—Ç —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (—ç—Ç–æ —É–≥–æ–ª PI/2 –≤ Canvas).
        // –ú—ã –≤—ã—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π —É–≥–æ–ª —Ü–µ–ª–∏, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é.
        let hitAngle = (Math.PI / 2) - target.angle;
        hitAngle = normalize(hitAngle);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –Ω–æ–∂–∞–º–∏
        const minDistance = 0.22; // –ü—Ä–∏–º–µ—Ä–Ω–æ 13 –≥—Ä–∞–¥—É—Å–æ–≤
        for (let a of target.stuckKnives) {
            let diff = Math.abs(normalize(a) - hitAngle);
            if (diff < minDistance || diff > (Math.PI * 2 - minDistance)) {
                endGame();
                return;
            }
        }

        // –£—Å–ø–µ—Ö
        target.stuckKnives.push(hitAngle);
        target.shakeY = -8; // –≠—Ñ—Ñ–µ–∫—Ç —Ç–æ–ª—á–∫–∞
        gameState.score++;
        gameState.knivesRemaining--;
        updateUI();

        if (gameState.knivesRemaining <= 0) {
            setTimeout(() => {
                gameState.level++;
                setupLevel(gameState.level);
            }, 100);
        }
        
        resetKnife();
    }

    function resetKnife() {
        knife.y = canvas.height - 120;
        knife.isReady = true;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –†–∏—Å—É–µ–º –±—Ä–µ–≤–Ω–æ –∏ –Ω–æ–∂–∏ –≤ –Ω–µ–º
        ctx.save();
        ctx.translate(target.x, target.y + target.shakeY);
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±—Ä–µ–≤–Ω–∞ (–≤—Ä–∞—â–∞–µ—Ç—Å—è)
        ctx.save();
        ctx.rotate(target.angle);
        
        ctx.beginPath();
        ctx.arc(0, 0, target.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#5d4037';
        ctx.fill();
        ctx.lineWidth = 8;
        ctx.strokeStyle = '#3e2723';
        ctx.stroke();

        // –£–∑–æ—Ä—ã –Ω–∞ –¥–µ—Ä–µ–≤–µ
        ctx.beginPath();
        ctx.arc(0, 0, target.radius - 15, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
        ctx.stroke();
        ctx.restore();

        // –†–∏—Å—É–µ–º –≤–æ—Ç–∫–Ω—É—Ç—ã–µ –Ω–æ–∂–∏ (–≤—Ä–∞—â–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –±—Ä–µ–≤–Ω–æ–º)
        target.stuckKnives.forEach(angle => {
            ctx.save();
            ctx.rotate(target.angle + angle);
            ctx.translate(0, target.radius - 5);
            // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–∂ —Ä—É—á–∫–æ–π –Ω–∞—Ä—É–∂—É
            drawKnifeShape();
            ctx.restore();
        });

        ctx.restore();

        // –†–∏—Å—É–µ–º –Ω–æ–∂ –∏–≥—Ä–æ–∫–∞
        if (knife.isReady || knife.isFlying) {
            ctx.save();
            ctx.translate(knife.x, knife.y);
            drawKnifeShape();
            ctx.restore();
        }
    }

    function drawKnifeShape() {
        // –õ–µ–∑–≤–∏–µ (—Å–º–æ—Ç—Ä–∏—Ç –≤ –¥–µ—Ä–µ–≤–æ)
        ctx.fillStyle = '#ecf0f1';
        ctx.beginPath();
        ctx.moveTo(-knife.w/2, 0);
        ctx.lineTo(knife.w/2, 0);
        ctx.lineTo(0, -knife.h * 0.7);
        ctx.fill();

        // –†—É–∫–æ—è—Ç—å (—Å–º–æ—Ç—Ä–∏—Ç –æ—Ç –¥–µ—Ä–µ–≤–∞)
        ctx.fillStyle = '#e67e22';
        ctx.fillRect(-knife.w/2, 0, knife.w, knife.h * 0.3);
    }

    function gameLoop() {
        update();
        draw();
        if (gameState.isRunning) requestAnimationFrame(gameLoop);
    }

    function endGame() {
        gameState.isRunning = false;
        document.getElementById('finalScore').textContent = gameState.score;
        document.getElementById('game-over').style.display = 'flex';
    }

    function updateUI() {
        document.getElementById('levelNum').textContent = gameState.level;
        const container = document.getElementById('knivesCounter');
        container.innerHTML = '';
        for (let i = 0; i < gameState.knivesToThrow; i++) {
            const div = document.createElement('div');
            div.className = 'knife-icon' + (i < gameState.knivesRemaining ? ' active' : '');
            div.innerHTML = 'üó°Ô∏è';
            container.appendChild(div);
        }
    }

    function normalize(a) {
        a = a % (Math.PI * 2);
        if (a < 0) a += Math.PI * 2;
        return a;
    }

    canvas.addEventListener('mousedown', () => {
        if (knife.isReady && !knife.isFlying && gameState.isRunning) {
            knife.isFlying = true;
            knife.isReady = false;
        }
    });
// –î–ª—è –º–æ–±–∏–ª–æ–∫
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (knife.isReady && !knife.isFlying && gameState.isRunning) {
            knife.isFlying = true;
            knife.isReady = false;
        }
    }, {passive: false});

    initGame();
</script>

</body>
</html>
